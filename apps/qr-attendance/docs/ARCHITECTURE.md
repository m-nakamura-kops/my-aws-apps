# QRコード打刻システム アーキテクチャ詳細

## システムアーキテクチャ

### 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│                        クライアント層                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Web Browser / Smartphone                            │  │
│  │  - Next.js アプリケーション                           │  │
│  │  - QRコードスキャン機能                               │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬───────────────────────────────────────┘
                        │ HTTPS
                        │
        ┌───────────────▼────────────────┐
        │     AWS Amplify Hosting        │
        │  - CDN配信                      │
        │  - SSL/TLS終端                 │
        │  - 自動スケーリング             │
        └───────────────┬────────────────┘
                        │
        ┌───────────────▼────────────────┐
        │     Amazon Cognito              │
        │  - ユーザー認証                 │
        │  - セッション管理               │
        │  - JWTトークン発行              │
        └───────────────┬────────────────┘
                        │
        ┌───────────────▼────────────────┐
        │     API Gateway                │
        │  - REST API                    │
        │  - リクエストルーティング        │
        │  - レート制限                   │
        │  - CORS設定                    │
        └───────────────┬────────────────┘
                        │
        ┌───────────────▼────────────────┐
        │     AWS Lambda                 │
        │  ┌──────────────────────────┐  │
        │  │ 認証関数                 │  │
        │  │ ユーザー管理関数          │  │
        │  │ イベント管理関数          │  │
        │  │ 打刻処理関数              │  │
        │  │ 管理者機能関数            │  │
        │  └──────────────────────────┘  │
        └───────────────┬────────────────┘
                        │
        ┌───────────────▼────────────────┐
        │     Amazon RDS                 │
        │  - MySQL/MariaDB                │
        │  - マルチAZ配置                 │
        │  - 自動バックアップ             │
        └────────────────────────────────┘
```

## データフロー

### 1. ユーザーログイン

```
1. ユーザー → Amplify: ログインリクエスト
2. Amplify → API Gateway: POST /v1/users/login
3. API Gateway → Lambda (auth): 認証処理
4. Lambda → Cognito: 認証確認
5. Cognito → Lambda: 認証結果
6. Lambda → RDS: ユーザー情報取得
7. Lambda → API Gateway: JWTトークン + ユーザー情報
8. API Gateway → Amplify: レスポンス
9. Amplify → ユーザー: トークン保存
```

### 2. QRコード打刻

```
1. ユーザー → Amplify: QRコードスキャン
2. Amplify → API Gateway: POST /v1/attendance/punch
3. API Gateway → Lambda (attendance): 打刻処理
4. Lambda → RDS: 
   - QRコード検証
   - 既存打刻チェック（入室/退室判定）
   - attendance_logsテーブル更新
5. Lambda → API Gateway: 打刻結果
6. API Gateway → Amplify: レスポンス
7. Amplify → ユーザー: 打刻完了通知
```

## セキュリティアーキテクチャ

### 認証・認可

1. **Cognito User Pool**: ユーザー認証
2. **JWTトークン**: API認証
3. **IAMロール**: Lambda実行権限
4. **VPC**: データベースアクセス制限
5. **セキュリティグループ**: ネットワークアクセス制御

### データ保護

1. **暗号化**: 
   - 転送時: TLS/SSL
   - 保存時: RDS暗号化
2. **パスワード**: Cognitoでハッシュ化
3. **機密情報**: AWS Secrets Managerで管理

## スケーラビリティ

### フロントエンド
- Amplify CDNによるグローバル配信
- 自動スケーリング

### バックエンド
- Lambda自動スケーリング
- API Gatewayスロットリング設定
- RDS読み取りレプリカ（必要に応じて）

### データベース
- RDS自動スケーリング
- 接続プーリング
- インデックス最適化

## 監視・ログ

### CloudWatch
- Lambda実行ログ
- API Gatewayアクセスログ
- RDSメトリクス
- カスタムメトリクス

### アラート
- エラー率
- レスポンス時間
- データベース接続数
- ディスク使用率

## 災害復旧

### バックアップ
- RDS自動バックアップ（日次）
- ポイントインタイムリカバリ
- クロスリージョンレプリカ（オプション）

### 可用性
- マルチAZ配置
- 自動フェイルオーバー

## コスト最適化

### Lambda
- 適切なメモリ設定
- プロビジョンド同時実行数（必要に応じて）

### RDS
- 適切なインスタンスサイズ
- 自動停止（開発環境）

### API Gateway
- キャッシュ設定（可能な場合）

## 開発・デプロイフロー

```
開発者
  ↓
ローカル開発環境
  ↓
GitHub (コード管理)
  ↓
GitHub Actions (CI/CD)
  ↓
AWS環境
  ├─ Amplify (フロントエンド)
  ├─ Lambda (バックエンド)
  └─ RDS (データベース)
```

## 技術スタック詳細

### フロントエンド
- **Next.js 14+**: SSR/SSG対応
- **React 18+**: UIライブラリ
- **TypeScript**: 型安全性
- **Tailwind CSS**: スタイリング
- **AWS Amplify UI**: UIコンポーネント

### バックエンド
- **Node.js 18+**: ランタイム
- **TypeScript**: 型安全性
- **AWS Lambda**: サーバーレス実行
- **API Gateway**: REST API

### データベース
- **MySQL 8.0+ / MariaDB 10.6+**: RDBMS
- **接続プーリング**: mysql2

### インフラ
- **AWS CDK**: Infrastructure as Code
- **CloudFormation**: リソース管理

## パフォーマンス目標

- APIレスポンス時間: < 500ms (p95)
- ページロード時間: < 2秒
- データベースクエリ: < 100ms (p95)
- 可用性: 99.9%
