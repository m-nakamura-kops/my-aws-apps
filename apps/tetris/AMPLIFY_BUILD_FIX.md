# Amplify ビルド失敗の修正ガイド

## 問題の確認

デプロイが失敗した場合、まずAmplifyコンソールでビルドログを確認してください。

### ビルドログの確認方法

1. Amplifyコンソールで「デプロイ 2」をクリック
2. 「ビルドログ」タブを開く
3. エラーメッセージを確認

## よくある原因と対処法

### 1. ルートディレクトリの設定

Amplifyコンソールで「アプリ設定」→「ビルド設定」を確認：

- **ルートディレクトリが `/`（リポジトリルート）の場合**
  - ルートの `amplify.yml` が使用されます
  - このファイルは `cd apps/tetris` を実行します

- **ルートディレクトリが `apps/tetris` の場合**
  - `apps/tetris/amplify.yml` が使用されます
  - このファイルは相対パスを使用します

### 2. Node.jsバージョンの問題

AmplifyコンソールでNode.jsバージョンを確認：

1. 「アプリ設定」→「ビルド設定」→「環境変数」
2. Node.js 18.x以上を推奨
3. 環境変数に以下を追加（必要に応じて）：
   ```
   NODE_VERSION=18
   ```

### 3. ビルド成果物のパス

「出力ディレクトリをビルド」の設定を確認：

- ルートディレクトリが `/` の場合：`apps/tetris/.next`
- ルートディレクトリが `apps/tetris` の場合：`.next`

### 4. 依存関係のインストールエラー

`npm ci` が失敗する場合：

- `package-lock.json` が存在することを確認
- ルートディレクトリが正しく設定されていることを確認

## 修正内容

両方の `amplify.yml` ファイルに以下を追加しました：

1. **デバッグ情報の追加**
   - 現在のディレクトリを表示
   - Node.js/NPMバージョンを表示

2. **エラーハンドリングの改善**
   - 各ステップでメッセージを表示

## 次のステップ

1. **Amplifyコンソールで設定を確認**
   - 「アプリ設定」→「ビルド設定」→「ルートディレクトリ」を確認
   - ルートディレクトリが `/` または `apps/tetris` のどちらかに設定されているか確認

2. **ビルドログを確認**
   - エラーメッセージを特定
   - 上記の対処法を試す

3. **再デプロイ**
   - 「このバージョンを再デプロイ」ボタンをクリック

## トラブルシューティング

### エラー: "npm ci failed"

**原因**: `package-lock.json` が見つからない、またはルートディレクトリが間違っている

**対処法**:
- ルートディレクトリが `apps/tetris` に設定されていることを確認
- または、ルートディレクトリが `/` の場合、ルートの `amplify.yml` が使用されることを確認

### エラー: "Build failed"

**原因**: Next.jsのビルドが失敗している

**対処法**:
- ビルドログで具体的なエラーメッセージを確認
- ローカルで `npm run build` を実行してエラーを再現

### エラー: "Artifacts not found"

**原因**: `baseDirectory` のパスが間違っている

**対処法**:
- ルートディレクトリに応じて `baseDirectory` を確認
- ルートディレクトリが `/` の場合：`apps/tetris/.next`
- ルートディレクトリが `apps/tetris` の場合：`.next`

## 確認事項チェックリスト

- [ ] Amplifyコンソールでルートディレクトリを確認
- [ ] ビルドログでエラーメッセージを確認
- [ ] Node.jsバージョンが18.x以上であることを確認
- [ ] `package-lock.json` が存在することを確認
- [ ] ローカルで `npm run build` が成功することを確認
